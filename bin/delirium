#!/usr/bin/env sage
"""delirium -- a reducer of differential equations for multiloop master integrals

Usage:
  delirium partial_fraction [-o <file_output>] <file_input>
  delirium reduce_at_one_point [-o <file_output>] <file_input>
  delirium maple_super_reduce [-p <point>] [-o <file_output>] <file_input>

Options:
  -p <point>        polinomial in x [default: x]
  -o <file_output>  output file name

Arguments:
  <file_input>      input file name
"""
import logging

from   docopt_dispatch import dispatch as docopt_dispatch
import sage.all

from   delirium import __version__
from   delirium.maple import super_reduce
from   delirium.matrix import degree_low, export_matrix, import_matrix, partial_fraction, var
from   delirium.reduction import reduce_at_one_point

log = logging.getLogger('delirium')

def main():
    print('\033[35m'+'Delirium v'+__version__+'\033[0m')
    print """Authors:
    Oleksandr Gituliar, Institute of Nuclear Physics, Krakow (Poland)
    Vitaly Magerya
    """
    docopt_dispatch(__doc__)

@docopt_dispatch.on('maple_super_reduce')
def on_maple_super_reduce(file_input, **kwargs):
    with open(file_input, 'r') as f:
        m = import_matrix(f)

    x = var('x')
    point = kwargs.get('p')
    mm, t = super_reduce(m, point)
    mm = partial_fraction(mm, x)

    file_output = kwargs.get('o')
    if file_output is not None:
        with open(file_output, 'w') as f:
            export_matrix(f, mm)

@docopt_dispatch.on('reduce_at_one_point')
def on_reduce_at_one_point(file_input, **kwargs):
    with open(file_input, 'r') as f:
        m = import_matrix(f)

    x = var('x')
    p = -1*degree_low(m, x)
    mm, t = reduce_at_one_point(m, x, 0, p)
    mm = partial_fraction(mm, x)

    file_output = kwargs.get('o')
    if file_output is not None:
        with open(file_output, 'w') as f:
            export_matrix(f, mm)
    else:
        log.info("\nNew matrix\n" + str(mm))
        log.info("\nTransformation\n" + str(t))

if __name__ == '__main__':
    main()

